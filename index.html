<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Narrative Visualization - Scene 1</title>
  <!-- Include D3.js library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <div>
    <label for="year-select">Select Year:</label>
    <select id="year-select"></select>
  </div>
  <div id="chart-container"></div>

  <div>
    <button id="previous-button" style="display: none;">Previous</button>
    <button id="next-button">Next</button>
  </div>
  <div id="scene2-container" style="display: none;">
    <div>
      <label for="country-select-1">Select Country (Set 1):</label>
      <select id="country-select-1"></select>
    </div>
    <div id="graph-container-1" style="display: inline-block; vertical-align: top;">
      <div id="interest-rate-chart-1"></div>
      <div id="inflation-rate-chart-1"></div>
    </div>
    <div>
      <label for="country-select-2">Select Country (Set 2):</label>
      <select id="country-select-2"></select>
    </div>
    <div id="graph-container-2" style="display: inline-block; vertical-align: top;">
      <div id="interest-rate-chart-2"></div>
      <div id="inflation-rate-chart-2"></div>
    </div>
    <div>
      <button id="previous-button">Previous</button>
    </div>
  </div>
  
  <script>
    let sceneCounter = 1;
    d3.csv("inflation-interest-unemployment.csv").then(data => {
      const years = Array.from(new Set(data.map(d => d.year)));

      d3.select("#year-select")
        .selectAll("option")
        .data(years)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);

      const defaultYear = "2010";

      d3.select("#year-select").property("value", defaultYear);

      updateGraph(defaultYear);

      d3.select("#year-select").on("change", function() {
        const selectedYear = this.value;
        updateGraph(selectedYear);
      });

      d3.select("#next-button").on("click", function() {
        if (sceneCounter === 1) {
          sceneCounter = 2;
          showScene2();
        }
      });

      d3.select("#previous-button").on("click", function() {
        if (sceneCounter === 2) {
          sceneCounter = 1;
          showScene1();
        }
      });

      function updateGraph(selectedYear) {
        if(sceneCounter === 1){
          const filteredData = data.filter(d => d.year === selectedYear);

          const margin = { top: 50, right: 50, bottom: 70, left: 70 };
          const width = 800 - margin.left - margin.right;
          const height = 500 - margin.top - margin.bottom;

          const svg = d3.select("#chart-container")
            .html("")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

          const xScale = d3.scaleLinear()
            .domain(d3.extent(filteredData, d => +d['Real interest rate (%)']))
            .range([0, width]);

          const yScale = d3.scaleLinear()
            .domain(d3.extent(filteredData, d => +d['Inflation, consumer prices (annual %)']))
            .range([height, 0]);

          const colorScale = d3.scaleOrdinal()
            .domain(['High income', 'Upper middle income', 'Lower middle income', 'Low income'])
            .range(['blue', 'green', 'orange', 'red']);

          const circles = svg.selectAll("circle")
            .data(filteredData)
            .enter()
            .append("circle")
            .attr("cx", d => xScale(+d['Real interest rate (%)']))
            .attr("cy", d => yScale(+d['Inflation, consumer prices (annual %)']))
            .attr("r", 5)
            .attr("fill", d => colorScale(d.incomeLevel));

          const labels = svg.selectAll("text")
            .data(filteredData)
            .enter()
            .append("text")
            .attr("x", d => xScale(+d['Real interest rate (%)']) + 7)
            .attr("y", d => yScale(+d['Inflation, consumer prices (annual %)']) + 4)
            .text(d => d['country'])
            .attr("font-size", "10px")
            .attr("fill", "black")
            .style("visibility", "hidden");

          //show country label
          circles.on("mouseover", function (event, d) {
            d3.select(this).attr("r", 8);
            labels.filter(labelData => labelData === d)
              .style("visibility", "visible");
          });

          // Hide country label
          circles.on("mouseout", function (event, d) {
            d3.select(this).attr("r", 5);
            labels.filter(labelData => labelData === d)
              .style("visibility", "hidden");
          });

          const xAxis = d3.axisBottom(xScale);
          const yAxis = d3.axisLeft(yScale);

          svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(xAxis);

          svg.append("g")
            .call(yAxis);

          svg.append("text")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom / 2)
            .attr("text-anchor", "middle")
            .text("Real Interest Rate (%)");

          svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", 0 - height / 2)
            .attr("y", -margin.left / 2)
            .attr("text-anchor", "middle")
            .text("Inflation Rate (Annual %)");
        }
        else if (sceneCounter === 2) {
          const filteredData = data.filter(d => d.year === selectedYear);
          const countries = Array.from(new Set(filteredData.map(d => d.country)));
          const countrySelect = d3.select("#country-select");

          countrySelect.selectAll("option").remove();

          //options for the country dropdown
          const countryOptions = countrySelect
            .selectAll("option")
            .data(countries)
            .enter()
            .append("option")
            .attr("value", d => d)
            .text(d => d);

          const defaultCountry = "United States";
          countrySelect.property("value", defaultCountry);

          updateLineGraphs(defaultCountry);

          countrySelect.on("change", function () {
            const selectedCountry = this.value;
            updateLineGraphs(selectedCountry);
          });
        }
      }

      function showScene1() {
        d3.select("#previous-button").style("display", "none");
        d3.select("#chart-container").style("display", "block");
        d3.select("#year-select").style("display", "block");
        d3.select("#next-button").style("display", "block");

        d3.select("#scene2-container").style("display", "none");

        d3.select("#year-select").property("value", defaultYear);
        d3.select("#scene2-container").insert("label", ":first-child")
          .attr("for", "year-select")
          .text("Select Year:");
      }

      function showScene2() {
        d3.select("#chart-container").style("display", "none");
        d3.select("#year-select").style("display", "none");
        d3.select("#next-button").style("display", "none");
        d3.select("#previous-button").style("display", "block");

        d3.select("#scene2-container").style("display", "block");

        d3.select("#country-select-1").selectAll("option").remove();
        d3.select("#country-select-2").selectAll("option").remove();

        sceneCounter = 2;

        const selectedYear = d3.select("#year-select").property("value");

        const defaultCountry1 = "Uganda";
        const filteredData1 = data.filter(d => d.year === selectedYear && d.country === defaultCountry1);
        updateLineGraphs(filteredData1, "1");

        const defaultCountry2 = "United States";
        const filteredData2 = data.filter(d => d.year === selectedYear && d.country === defaultCountry2);
        updateLineGraphs(filteredData2, "2");
      }

      function updateLineGraphs(selectedCountry, setNumber) {
        d3.select(`#interest-rate-chart-${setNumber}`).selectAll("svg").remove();
        d3.select(`#inflation-rate-chart-${setNumber}`).selectAll("svg").remove();
        const filteredData = data.filter(d => d.country === selectedCountry);

        const years = filteredData.map(d => d.year);
        const interestRates = filteredData.map(d => +d['Real interest rate (%)']);
        const inflationRates = filteredData.map(d => +d['Inflation, consumer prices (annual %)']);

        const margin = { top: 50, right: 50, bottom: 50, left: 50 };
        const width = 400 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;

        const interestRateSvg = d3.select(`#interest-rate-chart-${setNumber}`)
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left}, ${margin.top})`);

        const inflationRateSvg = d3.select(`#inflation-rate-chart-${setNumber}`)
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left}, ${margin.top})`);

        const xScale = d3.scaleBand()
          .domain(years)
          .range([0, width])
          .padding(0.1);

        const yScale = d3.scaleLinear()
          .domain([0, d3.max(interestRates, d => Math.max(d, d3.max(inflationRates)))])
          .range([height, 0]);

        const interestRateLine = d3.line()
          .x((d, i) => xScale(years[i]) + xScale.bandwidth() / 2)
          .y(d => yScale(d))
          .curve(d3.curveMonotoneX);

        const inflationRateLine = d3.line()
          .x((d, i) => xScale(years[i]) + xScale.bandwidth() / 2)
          .y(d => yScale(d))
          .curve(d3.curveMonotoneX);

        const xAxis = d3.axisBottom(xScale)
          .tickValues(xScale.domain().filter((d, i) => i % 5 === 0))
          .tickFormat(d3.format("d"));

        interestRateSvg.append("path")
          .datum(interestRates)
          .attr("fill", "none")
          .attr("stroke", "blue")
          .attr("stroke-width", 2)
          .attr("d", interestRateLine);

        inflationRateSvg.append("path")
          .datum(inflationRates)
          .attr("fill", "none")
          .attr("stroke", "green")
          .attr("stroke-width", 2)
          .attr("d", inflationRateLine);

        interestRateSvg.append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(xAxis)
          .selectAll("text")
          .attr("y", 10)
          .attr("x", -5)
          .attr("dy", ".35em")
          .attr("transform", "rotate(-45)")
          .style("text-anchor", "end");

        inflationRateSvg.append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(xAxis)
          .selectAll("text")
          .attr("y", 10)
          .attr("x", -5)
          .attr("dy", ".35em")
          .attr("transform", "rotate(-45)")
          .style("text-anchor", "end");

        interestRateSvg.append("g")
          .call(d3.axisLeft(yScale));

        inflationRateSvg.append("g")
          .call(d3.axisLeft(yScale));

        interestRateSvg.append("text")
          .attr("x", width / 2)
          .attr("y", -10)
          .attr("text-anchor", "middle")
          .text("Interest Rate vs. Year");

        inflationRateSvg.append("text")
          .attr("x", width / 2)
          .attr("y", -10)
          .attr("text-anchor", "middle")
          .text("Inflation Rate vs. Year");
      }
    });
  </script>
</body>
</html>
